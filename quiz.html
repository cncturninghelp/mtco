<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>HelpMeHelpYou — Dynamic CSV Loader</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{--bg:#0f1215;--panel:#171b21;--text:#e6e8eb;--muted:#8a9097;--border:#2b3139;--accent:#ff7a1a}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
header{padding:14px 18px;background:#12161c;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
.badge{display:inline-block;background:rgba(255,122,26,0.12);color:#ff7a1a;border:1px solid rgba(255,122,26,0.5);padding:5px 10px;border-radius:999px;font-size:12px}
select,button,input{background:#161c24;color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:8px}
button.primary{background:var(--accent);color:#111;border-color:transparent;font-weight:800}
main{max-width:1000px;margin:18px auto;padding:0 18px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px}
.center{text-align:center}
.big{font-size:42px;font-weight:900;text-align:center;margin:10px 0 14px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.answer.correct{background:rgba(72,199,142,0.12);border-color:rgba(72,199,142,0.6)}
.answer.wrong{background:rgba(255,100,100,0.12);border-color:rgba(255,100,100,0.6)}
.meta{color:var(--muted);text-align:center;margin-top:6px}
.hidden{display:none}
.table{width:100%;border-collapse:collapse;font-size:14px}
.table th,.table td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
.table th{background:#131820}
.loading{color:var(--accent);animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.error{color:#ff5555;background:rgba(255,85,85,0.1);padding:10px;border-radius:8px;margin:10px 0}
</style>
</head>
<body>
<header>
  <div>
    <strong>HelpMeHelpYou — Player</strong>
    <div class="badge" id="packBadge">Topic: Loading...</div>
  </div>
  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <label>Subject <select id="subjectSel" disabled><option value="all">All Subjects</option></select></label>
    <label>Topic <select id="packSel" disabled><option>Loading...</option></select></label>
    <span id="score">Score 0</span>
    <span id="streak">Streak 0</span>
    <span id="time">Time 6.0s</span>
    <label>Name <input id="name" maxlength="3" placeholder="AAA" style="width:70px;text-transform:uppercase"></label>
    <button id="openLb">Leaderboard</button>
    <button id="start" class="primary" disabled>Start Round</button>
  </div>
</header>
<main>
  <div id="startPanel" class="card center">
    <div class="big" id="packTitle">Loading quiz data...</div>
    <p class="meta loading" id="packDesc">Please wait while loading catalog...</p>
    <div id="loadLog" style="margin-top:20px;font-size:12px;color:var(--muted)"></div>
  </div>

  <div id="gamePanel" class="card hidden">
    <div class="badge" id="qBadge">Question 0/0</div>
    <div class="big" id="prompt">Prompt</div>
    <div id="answers" class="grid"></div>
    <div class="meta" id="meta"></div>
    <div style="text-align:center;margin-top:10px"><button id="endBtn">End Round</button></div>
  </div>

  <div id="endPanel" class="card hidden center">
    <div class="big">Round complete</div>
    <div class="meta" id="finalLine"></div>
    <div style="margin-top:10px;display:flex;gap:10px;justify-content:center">
      <button id="saveScore" class="primary">Save Score</button>
      <button id="again">Play Again</button>
    </div>
  </div>

  <div id="lbPanel" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong id="lbTitle">Leaderboard</strong> <span class="badge" id="lbTopic">(topic)</span></div>
      <div style="display:flex;gap:8px">
        <button id="lbClose">Close</button>
        <button id="lbClear">Clear This Topic</button>
      </div>
    </div>
    <div id="lbList" style="margin-top:10px"></div>
  </div>
</main>

<script>
// Parse CSV data from uploaded files if available
async function parseUploadedCSV(filename) {
  try {
    const csvText = await window.fs.readFile(filename, { encoding: 'utf8' });
    return parseCSVText(csvText);
  } catch (e) {
    console.log('No uploaded file found:', filename);
    return null;
  }
}

// Parse CSV text
function parseCSVText(text) {
  const lines = text.split(/\r?\n/).filter(line => line.trim());
  if (lines.length === 0) return [];
  
  // Parse headers
  const headers = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < lines[0].length; i++) {
    const char = lines[0][i];
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      headers.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  headers.push(current.trim());
  
  // Parse rows
  const rows = [];
  for (let lineIdx = 1; lineIdx < lines.length; lineIdx++) {
    const values = [];
    current = '';
    inQuotes = false;
    
    for (let i = 0; i < lines[lineIdx].length; i++) {
      const char = lines[lineIdx][i];
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        values.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    values.push(current.trim());
    
    const row = {};
    for (let i = 0; i < headers.length && i < values.length; i++) {
      row[headers[i]] = values[i];
    }
    rows.push(row);
  }
  
  return rows;
}

// Capitalize first letter of each word
function capitalizeWords(str) {
  return str.split('_').map(word => 
    word.charAt(0).toUpperCase() + word.slice(1)
  ).join(' ');
}

// Global quiz data - now with lazy loading structure
var CATALOG = [];  // Just the catalog entries
var MANIFESTS = {}; // Loaded manifests (id -> manifest)
var PACKS = {}; // Loaded pack data (id -> {title, items})
var SUBJECTS = {}; // Subject -> array of pack ids
var currentId = null;
var current = null;
var currentSubject = 'all';
var loadingPack = false; // Prevent double-loading

// DOM elements
var subjectSel = document.getElementById('subjectSel');
var packSel = document.getElementById('packSel');
var packBadge = document.getElementById('packBadge');
var packTitle = document.getElementById('packTitle');
var packDesc = document.getElementById('packDesc');
var startBtn = document.getElementById('start');
var startPanel = document.getElementById('startPanel');
var gamePanel = document.getElementById('gamePanel');
var endPanel = document.getElementById('endPanel');
var qBadge = document.getElementById('qBadge');
var promptEl = document.getElementById('prompt');
var answersEl = document.getElementById('answers');
var metaEl = document.getElementById('meta');
var timeEl = document.getElementById('time');
var scoreEl = document.getElementById('score');
var streakEl = document.getElementById('streak');
var endBtn = document.getElementById('endBtn');
var againBtn = document.getElementById('again');
var saveScoreBtn = document.getElementById('saveScore');
var nameInput = document.getElementById('name');
var lbBtn = document.getElementById('openLb');
var lbPanel = document.getElementById('lbPanel');
var lbClose = document.getElementById('lbClose');
var lbClear = document.getElementById('lbClear');
var lbList = document.getElementById('lbList');
var lbTitle = document.getElementById('lbTitle');
var lbTopic = document.getElementById('lbTopic');
var loadLog = document.getElementById('loadLog');

var NAME_KEY = 'hmhy:name';
var LB_PREFIX = 'hmhy:lb:';

function saveName(){ 
  localStorage.setItem(NAME_KEY, (nameInput.value || '').toUpperCase().slice(0,3)); 
  nameInput.value = localStorage.getItem(NAME_KEY) || ''; 
}
nameInput.oninput = saveName;
nameInput.value = (localStorage.getItem(NAME_KEY) || '').toUpperCase().slice(0,3);

function getLBKey(){ return LB_PREFIX + packSel.value; }
function loadLB(){ try{ return JSON.parse(localStorage.getItem(getLBKey())||'[]'); }catch(e){ return []; } }
function saveLB(arr){ localStorage.setItem(getLBKey(), JSON.stringify(arr)); }

function renderLB(){
  var arr = loadLB();
  arr.sort(function(a,b){ return b.score - a.score; });
  var rows = arr.slice(0,50).map(function(x,i){
    return '<tr><td>'+(i+1)+'</td><td><strong>'+(x.name||'---')+'</strong></td><td>'+x.score+'</td><td>'+new Date(x.when).toLocaleString()+'</td></tr>';
  }).join('');
  lbList.innerHTML = '<table class="table"><thead><tr><th>#</th><th>Name</th><th>Score</th><th>When</th></tr></thead><tbody>'+(rows || '<tr><td colspan="4" class="meta">No scores yet.</td></tr>')+'</tbody></table>';
  lbTitle.textContent = 'Leaderboard';
  lbTopic.textContent = current ? current.title : '';
}

lbBtn.onclick = function(){ renderLB(); lbPanel.classList.remove('hidden'); };
lbClose.onclick = function(){ lbPanel.classList.add('hidden'); };
lbClear.onclick = function(){ 
  if(current && confirm('Clear leaderboard for "'+current.title+'"?')){ 
    saveLB([]); 
    renderLB(); 
  } 
};

// Load individual pack data (CSV)
async function loadPackData(packId) {
  if (PACKS[packId] && PACKS[packId].items && PACKS[packId].items.length > 0) {
    // Already loaded
    return PACKS[packId];
  }
  
  if (loadingPack) return null; // Prevent double-loading
  loadingPack = true;
  
  packDesc.textContent = 'Loading pack data...';
  packDesc.classList.add('loading');
  
  try {
    const catalogEntry = CATALOG.find(p => p.id === packId);
    if (!catalogEntry) {
      throw new Error('Pack not found in catalog');
    }
    
    // Load manifest if not already loaded
    if (!MANIFESTS[packId]) {
      const manifestRes = await fetch(catalogEntry.href);
      if (!manifestRes.ok) throw new Error('Could not load manifest');
      MANIFESTS[packId] = await manifestRes.json();
    }
    
    const manifest = MANIFESTS[packId];
    
    // Initialize pack structure
    PACKS[packId] = {
      id: packId,
      title: manifest.title || catalogEntry.title,
      items: []
    };
    
    // Load CSV data
    if (manifest.source && manifest.source.href) {
      // First try uploaded file
      let csvData = await parseUploadedCSV(manifest.source.href);
      
      // If no uploaded file, try fetching
      if (!csvData) {
        const csvRes = await fetch(manifest.source.href);
        if (csvRes.ok) {
          const csvText = await csvRes.text();
          csvData = parseCSVText(csvText);
        }
      }
      
      if (csvData && csvData.length > 0) {
        // Map CSV columns to quiz format
        const cols = manifest.columns || {};
        PACKS[packId].items = csvData.map(row => ({
          prompt: row[cols.prompt || 'prompt'] || '',
          answer: row[cols.answer || 'answer'] || '',
          choices: row[cols.choices || 'choices'] ? 
            (row[cols.choices].includes('|') ? 
              row[cols.choices].split('|').map(s => s.trim()) : 
              [row[cols.choices]]) : null,
          topic: row[cols.topic || 'topic'] || '',
          family: row[cols.family || 'family'] || '',
          difficulty: row[cols.difficulty || 'difficulty'] || '',
          explain: row[cols.explain || 'explain'] || ''
        }));
      }
    }
    
    packDesc.textContent = PACKS[packId].items.length + ' items ready.';
    packDesc.classList.remove('loading');
    loadingPack = false;
    return PACKS[packId];
    
  } catch (error) {
    console.error('Error loading pack:', error);
    packDesc.textContent = 'Error loading pack data';
    packDesc.classList.remove('loading');
    loadingPack = false;
    return null;
  }
}

// Update topic dropdown based on selected subject
async function updateTopicDropdown() {
  packSel.innerHTML = '';
  
  let availablePacks = [];
  if (currentSubject === 'all') {
    availablePacks = CATALOG.map(p => p.id);
  } else {
    availablePacks = SUBJECTS[currentSubject] || [];
  }
  
  if (availablePacks.length === 0) {
    packSel.innerHTML = '<option>No topics available</option>';
    packSel.disabled = true;
    startBtn.disabled = true;
    packTitle.textContent = 'No topics available';
    packDesc.textContent = 'No topics found for this subject';
    return;
  }
  
  for (const id of availablePacks) {
    const catalogEntry = CATALOG.find(p => p.id === id);
    if (catalogEntry) {
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = catalogEntry.title;
      packSel.appendChild(opt);
    }
  }
  
  packSel.disabled = false;
  
  // Select first available topic
  currentId = availablePacks[0];
  packSel.value = currentId;
  
  // Load the selected pack
  await selectPack(currentId);
}

// Select and load a pack
async function selectPack(packId) {
  currentId = packId;
  const catalogEntry = CATALOG.find(p => p.id === packId);
  
  if (!catalogEntry) return;
  
  packBadge.textContent = 'Topic: ' + catalogEntry.title;
  packTitle.textContent = catalogEntry.title;
  packDesc.textContent = 'Loading...';
  packDesc.classList.add('loading');
  startBtn.disabled = true;
  
  // Load pack data
  const pack = await loadPackData(packId);
  
  if (pack && pack.items && pack.items.length > 0) {
    current = pack;
    packDesc.textContent = pack.items.length + ' items ready.';
    packDesc.classList.remove('loading');
    startBtn.disabled = false;
  } else {
    packDesc.textContent = 'No items available';
    packDesc.classList.remove('loading');
    current = null;
  }
  
  if (!lbPanel.classList.contains('hidden')) renderLB();
}

// Subject selector change handler
subjectSel.onchange = function() {
  currentSubject = subjectSel.value;
  updateTopicDropdown();
};

// Topic selector change handler
packSel.onchange = function() {
  selectPack(packSel.value);
};

// Initial catalog load (lightweight)
async function loadCatalog() {
  const logMessages = [];
  
  try {
    const response = await fetch('catalog.json');
    
    if (!response.ok) {
      throw new Error('Could not load catalog.json - ensure files are served from a web server');
    }
    
    const catalog = await response.json();
    CATALOG = catalog.packs || [];
    logMessages.push('Loaded catalog with ' + CATALOG.length + ' topics');
    
    // Extract subjects from catalog paths
    for (const packInfo of CATALOG) {
      const pathParts = packInfo.href.split('/');
      if (pathParts.length >= 3 && pathParts[0] === 'data') {
        const subjectName = pathParts[1];
        if (!SUBJECTS[subjectName]) {
          SUBJECTS[subjectName] = [];
        }
        SUBJECTS[subjectName].push(packInfo.id);
      }
    }
    
    // Log found subjects
    Object.keys(SUBJECTS).forEach(subject => {
      logMessages.push('Found subject: ' + subject + ' (' + SUBJECTS[subject].length + ' packs)');
    });
    
  } catch (error) {
    logMessages.push('ERROR: ' + error.message);
    loadLog.innerHTML = '<div class="error">' + logMessages.join('<br>') + '</div>';
    packTitle.textContent = 'Failed to load quiz data';
    packDesc.textContent = 'Please ensure files are served from a web server';
    return;
  }
  
  // Display log
  loadLog.innerHTML = logMessages.join('<br>');
  
  // Populate subject dropdown
  subjectSel.innerHTML = '<option value="all">All Subjects</option>';
  const subjects = Object.keys(SUBJECTS).filter(subject => SUBJECTS[subject].length > 0).sort();
  
  for (const subject of subjects) {
    const opt = document.createElement('option');
    opt.value = subject;
    opt.textContent = capitalizeWords(subject) + ' (' + SUBJECTS[subject].length + ')';
    subjectSel.appendChild(opt);
  }
  
  // Check if we have any packs
  if (CATALOG.length === 0) {
    packTitle.textContent = 'No quiz data found';
    packDesc.textContent = 'Could not load any quiz topics';
    return;
  }
  
  // Enable controls and populate topics
  subjectSel.disabled = false;
  await updateTopicDropdown();
  
  packTitle.textContent = 'Choose a subject and topic to begin';
}

// Game state
var GAME = {timer:null, t:6.0, order:[], idx:0, score:0, streak:0};

function shuffle(a){ 
  for(var i=a.length-1;i>0;i--){ 
    var j=Math.floor(Math.random()*(i+1)); 
    var t=a[i]; a[i]=a[j]; a[j]=t; 
  } 
  return a; 
}

function buildOptions(item){
  var wrongs = [];
  if(item.choices && item.choices.length>=3){ 
    wrongs = item.choices.slice(0,3); 
  } else {
    var pool = (current.items||[]).map(function(x){return x.answer;})
      .filter(function(v){return v && v!==item.answer;});
    shuffle(pool);
    for(var i=0;i<pool.length && wrongs.length<3;i++){ 
      if(wrongs.indexOf(pool[i])===-1) wrongs.push(pool[i]); 
    }
  }
  var opts = [{v:item.answer, ok:true}];
  for(var j=0;j<wrongs.length && j<3;j++){ 
    opts.push({v:wrongs[j], ok:false}); 
  }
  while(opts.length<4){ 
    opts.push({v:'(blank)', ok:false}); 
  }
  return shuffle(opts).slice(0,4);
}

function showQuestion(){
  var item = current.items[GAME.order[GAME.idx]];
  qBadge.textContent = 'Question '+(GAME.idx+1)+'/'+GAME.order.length;
  promptEl.textContent = item && item.prompt ? item.prompt : '(no prompt)';
  answersEl.innerHTML = '';
  var opts = buildOptions(item || {});
  for(var k=0;k<opts.length;k++){
    var o=opts[k]; 
    var btn=document.createElement('button'); 
    btn.className='answer'; 
    btn.textContent=o.v;
    btn.setAttribute('data-ok', o.ok ? 'true' : 'false');
    btn.onclick=(function(ok,btn){ return function(){ choose(ok, btn); }; })(o.ok, btn);
    answersEl.appendChild(btn);
  }
  metaEl.textContent = [item.family||'', item.difficulty||'', item.topic||''].filter(Boolean).join(' • ');
  startTimer();
}

function startTimer(){
  clearInterval(GAME.timer);
  GAME.t = 6.0; 
  timeEl.textContent = 'Time '+GAME.t.toFixed(1)+'s';
  var t0 = performance.now();
  GAME.timer = setInterval(function(){
    var el = (performance.now()-t0)/1000;
    GAME.t = Math.max(0, 6.0 - el);
    timeEl.textContent = 'Time '+GAME.t.toFixed(1)+'s';
    if(GAME.t<=0){ clearInterval(GAME.timer); timeout(); }
  }, 100);
}

function timeout(){ 
  var btns = answersEl.querySelectorAll('button'); 
  for(var i=0;i<btns.length;i++){ btns[i].disabled = true; }
  var correctBtn = answersEl.querySelector('button[data-ok="true"]');
  if(correctBtn){ correctBtn.classList.add('correct'); }

  GAME.streak = 0;
  scoreEl.textContent = 'Score '+GAME.score; 
  streakEl.textContent = 'Streak '+GAME.streak;
  setTimeout(function(){ next(); }, 650); 
}

function choose(ok, btn){
  clearInterval(GAME.timer);
  var btns = answersEl.querySelectorAll('button'); 
  for(var i=0;i<btns.length;i++){ btns[i].disabled = true; }
  
  if(ok){ 
    btn.classList.add('correct'); 
    GAME.streak++; 
    GAME.score += 100 + Math.round(400*(GAME.t/6.0)); 
  } else { 
    btn.classList.add('wrong'); 
    var correctBtn = answersEl.querySelector('button[data-ok="true"]');
    if(correctBtn){ correctBtn.classList.add('correct'); }
    GAME.streak = 0; 
  }
  
  scoreEl.textContent = 'Score '+GAME.score; 
  streakEl.textContent = 'Streak '+GAME.streak;
  setTimeout(function(){ next(); }, 650);
}

function next(){
  GAME.idx++;
  if(GAME.idx >= GAME.order.length){ endRound(); return; }
  showQuestion();
}

function endRound(){
  gamePanel.classList.add('hidden');
  endPanel.classList.remove('hidden');
  document.getElementById('finalLine').textContent = 'Score '+GAME.score+' • Questions '+GAME.order.length+' • Best streak '+GAME.streak;
  
  var name = (localStorage.getItem(NAME_KEY)||'').toUpperCase().slice(0,3) || '---';
  var entry = {name:name, score:GAME.score, when:new Date().toISOString()};
  var arr = loadLB(); 
  arr.push(entry); 
  arr.sort(function(a,b){ return b.score - a.score; }); 
  arr = arr.slice(0,50); 
  saveLB(arr);
  
  saveScoreBtn.onclick = function(){
    saveName();
    var e = {name:(localStorage.getItem(NAME_KEY)||'---'), score:GAME.score, when:new Date().toISOString()};
    var a = loadLB(); 
    a.push(e); 
    a.sort(function(x,y){ return y.score - x.score; }); 
    a = a.slice(0,50); 
    saveLB(a);
    alert('Saved!');
    if(!lbPanel.classList.contains('hidden')) renderLB();
  };
  
  if(!lbPanel.classList.contains('hidden')) renderLB();
}

startBtn.onclick = async function(){
  // Ensure pack is loaded
  if (!current || !current.items || current.items.length === 0) {
    if (currentId) {
      packDesc.textContent = 'Loading pack...';
      await loadPackData(currentId);
    }
  }
  
  if(!current || !(current.items && current.items.length)){ 
    alert('No items in this topic.'); 
    return; 
  }
  
  GAME.score = 0; 
  GAME.streak = 0; 
  GAME.idx = 0;
  var indices = []; 
  for(var i=0;i<current.items.length;i++) indices.push(i);
  shuffle(indices);
  GAME.order = indices.slice(0, Math.min(12, indices.length));
  startPanel.classList.add('hidden'); 
  endPanel.classList.add('hidden'); 
  gamePanel.classList.remove('hidden');
  showQuestion();
};

endBtn.onclick = function(){ endRound(); };
againBtn.onclick = function(){ 
  endPanel.classList.add('hidden'); 
  startPanel.classList.remove('hidden'); 
};

// Initialize on page load
window.addEventListener('DOMContentLoaded', function() {
  loadCatalog(); // Only load the catalog initially
});
</script>
</body>
</html>