<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MTCO — Gallery (trial v1)</title>
<style>
:root{
  /* MTCO global type tokens */
  --fs-body: 14px;
  --lh-body: 1.45;
  --fs-small: 12px;
  --fs-title: 16px; /* small in-page title */
  --fs-card: 14px;  /* card/section headers */

  --accent:#ff7a1a; --accent2:#ffa864;
  --bg:#0f1215; --panel:#161a1f; --card:#171b21; --border:#2b3139;
  --text:#e6e8eb; --muted:#8a9097; --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);
     font:14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
/* Header */
header{position:sticky; top:0; z-index:5; background:linear-gradient(180deg,#181d24,#14181d);
  border-bottom:1px solid var(--border); box-shadow:0 6px 24px rgba(0,0,0,.25)}
.wrap{max-width:1220px;margin:0 auto;padding:12px 14px;display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 2px 12px rgba(255,122,26,.35)}
.title{font-weight:800;font-size:18px;letter-spacing:.4px}
.subtitle{color:#cfd3d8;font-size:12px}
/* Controls */
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{padding:8px 12px;border:1px solid #2b3139;border-radius:999px;background:#11161c;color:var(--text);cursor:pointer}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#101114}
.btn:focus{outline:none;box-shadow:0 0 0 2px rgba(255,122,26,.35)}
input[type="file"]{display:none}
/* Main */
main{max-width:1220px;margin:14px auto;padding:0 14px 24px}
.tip{color:var(--muted);font-size:12px;margin:6px 0 12px 0}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px}
/* Drop zone */
.drop{border:1px dashed #2b3139;border-radius:12px;padding:16px;text-align:center;background:#0e1318;color:var(--muted)}
.drop.drag{border-color:var(--accent);color:#ffd7b0;background:rgba(255,122,26,.06)}
/* Masonry grid */
.masonry{column-count:4; column-gap:12px}
@media (max-width: 1100px){ .masonry{column-count:3} }
@media (max-width: 800px){ .masonry{column-count:2} }
@media (max-width: 560px){ .masonry{column-count:1} }
.tile{break-inside:avoid; margin:0 0 12px 0; position:relative; border-radius:12px; overflow:hidden; border:1px solid #2b3139; background:#0f141a}
.tile img{width:100%; height:auto; display:block}
.tile .cap{padding:8px 10px; font-size:12px; color:#d5d9de; border-top:1px solid #2b3139; background:#10151b}
.tile .cap[contenteditable="true"]{outline:none; box-shadow:inset 0 0 0 2px rgba(255,122,26,.25)}
.tile .actions{position:absolute; top:8px; right:8px; display:flex; gap:6px; z-index:2}
.iconbtn{border:1px solid #2b3139; background:rgba(16,21,27,.85); color:#e6e8eb; border-radius:8px; padding:4px 6px; cursor:pointer; font-size:12px}
.iconbtn:hover{border-color:#3a414b}
/* Lightbox */
.lightbox{position:fixed; inset:0; background:rgba(0,0,0,.75); display:none; align-items:center; justify-content:center; z-index:40}
.lightbox.active{display:flex}
.viewer{max-width:92vw; max-height:86vh; background:#0d1117; border:1px solid #2b3139; border-radius:12px; overflow:hidden; display:flex; flex-direction:column}
.viewer img{max-width:92vw; max-height:72vh; object-fit:contain; background:#0b0f14}
.viewer .vcap{padding:10px 12px; font-size:12px; color:#d5d9de; border-top:1px solid #2b3139; background:#10151b; display:flex; align-items:center; gap:8px}
.viewer .vcap input{flex:1; padding:7px 8px; border:1px solid #2b3139; border-radius:8px; background:#0f141a; color:#e6e8eb}
.viewer .bar{position:absolute; top:16px; right:16px; display:flex; gap:8px}
.navbtn{padding:8px 10px; border:1px solid #2b3139; border-radius:999px; background:#11161c; color:#e6e8eb; cursor:pointer}
.navbtn.primary{background:var(--accent); border-color:var(--accent); color:#101114}
/* Footer note */
.footer{color:var(--muted); font-size:12px; margin-top:10px}
/* Print (if someone prints the collage) */
@media print{
  header, .controls, .drop, .footer, .tile .actions { display:none !important }
  body{background:#fff;color:#000}
  .tile{border-color:#bbb}
  .tile .cap{background:#fff;color:#000;border-color:#ccc}
}
</style>
<style>
/* === MTCO Typography Normalization (site-wide) === */
body { font-size: var(--fs-body); line-height: var(--lh-body); }
label, .label, .hint, .help, .muted, small, .tiny, .badge { font-size: var(--fs-small); }
.inpage-title { font-size: var(--fs-title); font-weight: 600; }
.card h1, .card h2, .card h3, .section-title, .panel h2, .panel h3 { font-size: var(--fs-card); font-weight: 600; }
pre, code, .code, textarea, .output, .editor, textarea.code { font-size: var(--fs-body); line-height: var(--lh-body); }

</style>
<style>
/* === MTCO Typography Normalization (hardened) === */
body { font-size: var(--fs-body) !important; line-height: var(--lh-body) !important; }
label, .label, .hint, .help, .muted, small, .tiny, .badge { font-size: var(--fs-small) !important; }
.inpage-title { font-size: var(--fs-title) !important; font-weight: 600 !important; }
.card h1, .card h2, .card h3, .section-title, .panel h2, .panel h3 { font-size: var(--fs-card) !important; font-weight: 600 !important; }
pre, code, .code, textarea, .output, .editor, textarea.code { font-size: var(--fs-body) !important; line-height: var(--lh-body) !important; }

</style>
</head>
<body>
<main>
  <div class="card">
    <div id="drop" class="drop">Drop images here or click <b>Add photos</b>. You can add more any time.</div>
    <p class="tip">Tip: captions are editable — click the caption text. Click a tile to open the viewer; use ←/→ to navigate.</p>
    <input id="fileInput" type="file" accept="image/*" multiple>
    <div id="grid" class="masonry"></div>
    <div class="footer">Local autosave keeps your gallery in this browser. Use <b>Save as HTML</b> or <b>Export JSON</b> to back it up or move it.</div>
  </div>
</main>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" aria-modal="true" role="dialog">
  <div class="viewer">
    <div class="bar">
      <button class="navbtn" onclick="prev()">← Prev</button>
      <button class="navbtn" onclick="next()">Next →</button>
      <button class="navbtn" onclick="closeBox()">Close</button>
    </div>
    <img id="viewImg" src="" alt="">
    <div class="vcap">
      <input id="viewCap" type="text" placeholder="Add caption…">
      <button class="navbtn primary" onclick="saveCap()">Save</button>
    </div>
  </div>
</div>

<script>
const grid = document.getElementById('grid');
const fileInput = document.getElementById('fileInput');
const drop = document.getElementById('drop');
const lightbox = document.getElementById('lightbox');
const viewImg = document.getElementById('viewImg');
const viewCap = document.getElementById('viewCap');

let items = [];     // {id, dataURL, cap}
let activeIndex = -1;

// ---- Load from localStorage
(function(){
  try{
    const raw = localStorage.getItem('mtco_gallery_v1');
    if(raw){
      const data = JSON.parse(raw);
      if(Array.isArray(data)) { items = data; renderAll(); }
    }
  }catch(e){ console.warn('No local gallery or failed to parse.'); }
})();

function autosave(){
  try{ localStorage.setItem('mtco_gallery_v1', JSON.stringify(items)); }
  catch(e){ console.warn('Autosave failed (likely storage size). Use Export HTML/JSON instead.'); }
}

// ---- Render
function renderAll(){
  grid.innerHTML = '';
  for(const it of items){
    grid.appendChild(renderTile(it));
  }
}

function renderTile(it){
  const tile = document.createElement('div');
  tile.className = 'tile';
  tile.dataset.id = it.id;
  tile.innerHTML = `
    <div class="actions">
      <button class="iconbtn" data-act="del" title="Remove">✕</button>
      <button class="iconbtn" data-act="edit" title="Edit caption">✎</button>
    </div>
    <img src="${it.dataURL}" alt="${it.cap ? it.cap.replace(/"/g,'&quot;') : ''}" loading="lazy">
    <div class="cap" contenteditable="false">${it.cap || ''}</div>
  `;
  tile.querySelector('img').addEventListener('click', ()=> openBox(it.id));
  tile.addEventListener('click', (e)=>{
    const act = e.target.getAttribute('data-act');
    if(act === 'del'){ removeItem(it.id); e.stopPropagation(); }
    if(act === 'edit'){ toggleEdit(tile, true); e.stopPropagation(); }
  });
  return tile;
}

function toggleEdit(tile, on){
  const cap = tile.querySelector('.cap');
  cap.setAttribute('contenteditable', on ? 'true' : 'false');
  if(on){ cap.focus(); selectAll(cap); cap.addEventListener('blur', ()=> saveTileCap(tile)); }
  else { saveTileCap(tile); }
}
function selectAll(el){
  const r = document.createRange(); r.selectNodeContents(el);
  const s = window.getSelection(); s.removeAllRanges(); s.addRange(r);
}
function saveTileCap(tile){
  const id = tile.dataset.id;
  const cap = tile.querySelector('.cap').innerText.trim();
  const it = items.find(x=> x.id === id);
  if(it){ it.cap = cap; autosave(); }
  tile.querySelector('.cap').setAttribute('contenteditable','false');
}

// ---- Add photos
fileInput.addEventListener('change', handleFiles);
;['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, (e)=>{ e.preventDefault(); drop.classList.add('drag'); }));
;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, (e)=>{ e.preventDefault(); drop.classList.remove('drag'); }));
drop.addEventListener('drop', (e)=>{
  const files = Array.from(e.dataTransfer.files || []).filter(f=> f.type.startsWith('image/'));
  if(files.length) readFiles(files);
});

function handleFiles(e){
  const files = Array.from(e.target.files || []);
  if(files.length) readFiles(files);
  fileInput.value = '';
}

function readFiles(files){
  // Read sequentially to avoid memory spikes
  (function next(i){
    if(i>=files.length){ autosave(); return; }
    const f = files[i];
    const rdr = new FileReader();
    rdr.onload = (ev)=>{
      const id = Date.now().toString(36) + Math.random().toString(36).slice(2,7);
      const it = { id, dataURL: ev.target.result, cap: f.name.replace(/\.[^.]+$/,'') };
      items.push(it);
      grid.appendChild(renderTile(it));
      autosave();
      next(i+1);
    };
    rdr.readAsDataURL(f);
  })(0);
}

// ---- Remove
function removeItem(id){
  const idx = items.findIndex(x=> x.id === id);
  if(idx>=0){ items.splice(idx,1); }
  const el = grid.querySelector(`.tile[data-id="${id}"]`);
  if(el) el.remove();
  autosave();
}

// ---- Lightbox
function openBox(id){
  activeIndex = items.findIndex(x=> x.id === id);
  if(activeIndex<0) return;
  updateBox();
  lightbox.classList.add('active');
}
function updateBox(){
  const it = items[activeIndex];
  if(!it) return;
  viewImg.src = it.dataURL;
  viewCap.value = it.cap || '';
}
function closeBox(){ lightbox.classList.remove('active'); }
function prev(){ if(activeIndex>0){ activeIndex--; updateBox(); } }
function next(){ if(activeIndex<items.length-1){ activeIndex++; updateBox(); } }
document.addEventListener('keydown', (e)=>{
  if(!lightbox.classList.contains('active')) return;
  if(e.key==='Escape') closeBox();
  if(e.key==='ArrowLeft') prev();
  if(e.key==='ArrowRight') next();
});
function saveCap(){
  const it = items[activeIndex];
  if(!it) return;
  it.cap = viewCap.value.trim();
  // update tile caption
  const tile = grid.querySelector(`.tile[data-id="${it.id}"] .cap`);
  if(tile) tile.innerText = it.cap;
  autosave();
}

// ---- Export / Import
function exportJSON(){
  const data = items;
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'mtco_gallery.json';
  a.click(); URL.revokeObjectURL(a.href);
}
function importJSON(input){
  const file = input.files && input.files[0]; if(!file) return;
  const rdr = new FileReader();
  rdr.onload = (e)=>{
    try{
      const data = JSON.parse(e.target.result);
      if(Array.isArray(data)){
        items = data; renderAll(); autosave();
      }else{ alert('JSON does not look like a gallery.'); }
    }catch(err){ alert('Could not read JSON file.'); console.error(err); }
  };
  rdr.readAsText(file);
}

function exportHTML(){
  // Build a self-contained HTML with data embedded
  const data = JSON.stringify(items);
  const html = `<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>MTCO — Gallery (snapshot)</title>
  <style>
    body{margin:0;background:#0f1215;color:#e6e8eb;font:14px/1.45 ui-sans-serif, system-ui,-apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .wrap{max-width:1220px;margin:16px auto;padding:0 14px}
    h1{font-size:20px;margin:16px 0}
    .masonry{column-count:4; column-gap:12px}
    @media (max-width: 1100px){ .masonry{column-count:3} }
    @media (max-width: 800px){ .masonry{column-count:2} }
    @media (max-width: 560px){ .masonry{column-count:1} }
    .tile{break-inside:avoid; margin:0 0 12px 0; border:1px solid #2b3139; border-radius:12px; overflow:hidden; background:#0f141a}
    .tile img{width:100%; display:block}
    .tile .cap{padding:8px 10px; font-size:12px; color:#d5d9de; border-top:1px solid #2b3139; background:#10151b}
  </style><style>
/* === MTCO Typography Normalization (site-wide) === */
body { font-size: var(--fs-body); line-height: var(--lh-body); }
label, .label, .hint, .help, .muted, small, .tiny, .badge { font-size: var(--fs-small); }
.inpage-title { font-size: var(--fs-title); font-weight: 600; }
.card h1, .card h2, .card h3, .section-title, .panel h2, .panel h3 { font-size: var(--fs-card); font-weight: 600; }
pre, code, .code, textarea, .output, .editor, textarea.code { font-size: var(--fs-body); line-height: var(--lh-body); }

</style>
<style>
/* === MTCO Typography Normalization (hardened) === */
body { font-size: var(--fs-body) !important; line-height: var(--lh-body) !important; }
label, .label, .hint, .help, .muted, small, .tiny, .badge { font-size: var(--fs-small) !important; }
.inpage-title { font-size: var(--fs-title) !important; font-weight: 600 !important; }
.card h1, .card h2, .card h3, .section-title, .panel h2, .panel h3 { font-size: var(--fs-card) !important; font-weight: 600 !important; }
pre, code, .code, textarea, .output, .editor, textarea.code { font-size: var(--fs-body) !important; line-height: var(--lh-body) !important; }

</style>
</head><body>
  <div class="wrap"><h1>MTCO — Gallery</h1><div id="grid" class="masonry"></div></div>
  <script>
  const data = ${data};
  const grid = document.getElementById('grid');
  function render(){ grid.innerHTML=''; for(const it of data){ const d=document.createElement('div'); d.className='tile'; d.innerHTML='<img src="'+it.dataURL+'" alt=""><div class="cap">'+(it.cap||'')+'</div>'; grid.appendChild(d);} }
  render();
  <\/script></body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'mtco_gallery_snapshot.html'; a.click(); URL.revokeObjectURL(a.href);
}

function clearGallery(){
  if(!confirm('Clear all images from gallery?')) return;
  items = []; renderAll(); autosave();
}
</script>
</body>
</html>
